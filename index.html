<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Support Pro (Nojima Edition)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, className }) => {
            useEffect(() => { lucide.createIcons(); }, [name, className]);
            return <i data-lucide={name} className={className}></i>;
        };

        const CARRIER_DATA = {
            docomo: { name: "docomo", type: "main", color: "bg-rose-600", program: "いつでもカエドキプログラム", hasFee: true },
            au: { name: "au", type: "main", color: "bg-orange-500", program: "スマホトクするプログラム", hasFee: true },
            softbank: { name: "SoftBank", type: "main", color: "bg-slate-800", program: "新トクするサポート", hasFee: true },
            uq: { name: "UQ mobile", type: "sub", color: "bg-blue-600", program: "スマホトクするプログラム", hasFee: false },
            ymobile: { name: "Y!mobile", type: "sub", color: "bg-red-500", program: "新トクするサポート", hasFee: false }
        };

        const PLAN_PRESETS = {
            docomo: [{ n: "ドコモ MAX", p: 8448 }, { n: "ドコモ mini", p: 2500 }, { n: "ahamo", p: 2970 }],
            au: [{ n: "auバリューリンク", p: 8008 }, { n: "スマホミニプラン", p: 4928 }],
            softbank: [{ n: "ペイトク無制限", p: 9625 }, { n: "メリハリ無制限＋", p: 7425 }],
            uq: [{ n: "コミコミバリュー", p: 3828 }, { n: "トクトクプラン2", p: 4048 }],
            ymobile: [{ n: "シンプル3 S", p: 3058 }, { n: "シンプル3 M", p: 4158 }]
        };

        const INITIAL_STATE = (carrier) => ({
            carrier,
            device: { name: 'iPhone 17', price: 134800, installments: 48, monthly: 1, hasDownPayment: true },
            plan: { name: PLAN_PRESETS[carrier][0].n, price: PLAN_PRESETS[carrier][0].p },
            call: { name: 'なし', price: 0 },
            transfer: 0,
            discounts: [
                { id: 1, name: '家族割 (3回線)', amount: 1100, active: false },
                { id: 2, name: 'セット割 (光/Air)', amount: 1100, active: false }
            ],
            points: [{ id: 101, name: 'オプション加入特典', amount: 11000, active: true }]
        });

        const App = () => {
            const [activeSlot, setActiveSlot] = useState('A');
            const [slots, setSlots] = useState({ A: INITIAL_STATE('docomo'), B: INITIAL_STATE('uq') });
            const [showSummary, setShowSummary] = useState(false);
            const [checklist, setChecklist] = useState({ i: false, r: false, f: false, c: false, p: false });

            const current = slots[activeSlot];
            const carrier = CARRIER_DATA[current.carrier];

            // リアルタイム計算ロジック
            const calc = useMemo(() => {
                const s = current;
                let devMonthly = 0;
                let residual = 0;

                if (s.device.installments === 1) {
                    devMonthly = 0;
                } else if (s.device.installments === 48) {
                    devMonthly = Number(s.device.monthly) || 0;
                    residual = Math.max(0, s.device.price - (devMonthly * 23));
                } else {
                    devMonthly = Math.floor(s.device.price / s.device.installments);
                }

                const totalDisc = s.discounts.reduce((a, b) => b.active ? a + (Number(b.amount) || 0) : a, 0);
                const monthlyTotal = devMonthly + (Number(s.plan.price) || 0) + (Number(s.call.price) || 0) - totalDisc;
                const upfront = (s.device.hasDownPayment ? 11000 : 0) + Number(s.transfer) + (s.device.installments === 1 ? s.device.price : 0);
                const totalPoints = s.points.reduce((a, b) => b.active ? a + (Number(b.amount) || 0) : a, 0);

                return { devMonthly, residual, monthlyTotal, upfront, totalPoints };
            }, [current]);

            // 安全なステート更新関数 (Immutabilityを保証)
            const updateState = (path, value) => {
                setSlots(prev => {
                    const next = { ...prev };
                    const slot = { ...next[activeSlot] };
                    const keys = path.split('.');

                    if (keys.length === 2) {
                        slot[keys[0]] = { ...slot[keys[0]], [keys[1]]: value };
                    } else {
                        slot[keys[0]] = value;
                    }

                    next[activeSlot] = slot;
                    return next;
                });
            };

            return (
                <div className="min-h-screen pb-40">
                    <header className={`${carrier.color} text-white p-4 sticky top-0 z-50 shadow-md transition-colors`}>
                        <div className="max-w-2xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Icon name="smartphone" className="w-5 h-5" />
                                <h1 className="font-black text-sm italic">Sales Support Pro <span className="text-[10px] font-normal not-italic opacity-80">Nojima Ed.</span></h1>
                            </div>
                            <div className="flex bg-white/20 p-1 rounded-xl">
                                {['A', 'B'].map(s => (
                                    <button key={s} onClick={() => setActiveSlot(s)} className={`px-4 py-1.5 rounded-lg text-xs font-black transition ${activeSlot === s ? 'bg-white text-slate-900' : 'text-white'}`}>案 {s}</button>
                                ))}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-2xl mx-auto p-4 space-y-4">
                        {/* Step 1: Carrier */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                            <h2 className="text-[11px] font-black text-slate-400 mb-4 uppercase tracking-widest flex items-center gap-2">
                                <div className="w-1.5 h-3 bg-blue-600 rounded-full"></div> Step 1. キャリア
                            </h2>
                            <div className="grid grid-cols-3 gap-2 mb-2">
                                {Object.entries(CARRIER_DATA).filter(([_, v]) => v.type === 'main').map(([k, v]) => (
                                    <button key={k} onClick={() => setSlots(p => ({...p, [activeSlot]: INITIAL_STATE(k)}))} className={`py-3 rounded-2xl border-2 font-bold text-xs transition ${current.carrier === k ? `${v.color} border-transparent text-white shadow-lg` : 'bg-slate-50 border-transparent text-slate-400'}`}>{v.name}</button>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                {Object.entries(CARRIER_DATA).filter(([_, v]) => v.type === 'sub').map(([k, v]) => (
                                    <button key={k} onClick={() => setSlots(p => ({...p, [activeSlot]: INITIAL_STATE(k)}))} className={`py-3 rounded-2xl border-2 font-bold text-xs transition ${current.carrier === k ? `${v.color} border-transparent text-white shadow-lg` : 'bg-slate-50 border-transparent text-slate-400'}`}>{v.name}</button>
                                ))}
                            </div>
                        </section>

                        {/* Step 2: Device */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-4 text-left">
                            <h2 className="text-[11px] font-black text-slate-400 flex items-center gap-2 uppercase tracking-widest">
                                <div className="w-1.5 h-3 bg-blue-600 rounded-full"></div> Step 2. 端末設定
                            </h2>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="space-y-1">
                                    <span className="text-[10px] font-bold text-slate-400 ml-1">機種名</span>
                                    <input type="text" value={current.device.name} onChange={e => updateState('device.name', e.target.value)} className="w-full p-3 bg-slate-50 rounded-2xl text-xs font-black border-none ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 transition" />
                                </div>
                                <div className="space-y-1 text-right">
                                    <span className="text-[10px] font-bold text-slate-400 mr-1">総額 (税込)</span>
                                    <input type="number" value={current.device.price} onChange={e => updateState('device.price', Number(e.target.value))} className="w-full p-3 bg-slate-50 rounded-2xl text-xs font-black text-right border-none ring-1 ring-slate-100" />
                                </div>
                            </div>
                            <div className="flex bg-slate-100 p-1.5 rounded-2xl">
                                {[1, 24, 36, 48].map(n => (
                                    <button key={n} onClick={() => updateState('device.installments', n)} className={`flex-1 py-2 rounded-xl text-[10px] font-black transition ${current.device.installments === n ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}>{n === 1 ? '一括' : `${n}回`}</button>
                                ))}
                            </div>
                            {current.device.installments === 48 && (
                                <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex justify-between items-center">
                                    <div className="space-y-1">
                                        <span className="text-[9px] font-black text-blue-400 uppercase">23ヶ月目までの月額</span>
                                        <input type="number" value={current.device.monthly} onChange={e => updateState('device.monthly', Number(e.target.value))} className="w-24 p-2 bg-white rounded-lg border border-blue-200 text-sm font-black text-blue-600 focus:ring-2 focus:ring-blue-500" />
                                    </div>
                                    <div className="text-right">
                                        <span className="text-[9px] font-black text-slate-400 uppercase">25ヶ月目以降(免除額)</span>
                                        <p className="text-lg font-black text-slate-700 italic">¥{calc.residual.toLocaleString()}</p>
                                    </div>
                                </div>
                            )}
                        </section>

                        {/* Step 3: Plan */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-4 text-left">
                            <h2 className="text-[11px] font-black text-slate-400 flex items-center gap-2 uppercase tracking-widest">
                                <div className="w-1.5 h-3 bg-blue-600 rounded-full"></div> Step 3. プラン・通話
                            </h2>
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="text" value={current.plan.name} onChange={e => updateState('plan.name', e.target.value)} className="p-3 bg-slate-50 rounded-2xl text-xs font-black border-none ring-1 ring-slate-100" />
                                    <input type="number" value={current.plan.price} onChange={e => updateState('plan.price', Number(e.target.value))} className="p-3 bg-slate-50 rounded-2xl text-xs font-black text-right border-none ring-1 ring-slate-100" />
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                    {[ {n:'なし', p:0}, {n:'5分無料', p:880}, {n:'放題', p:1980} ].map(o => (
                                        <button key={o.n} onClick={() => updateState('call', {name:o.n, price:o.p})} className={`py-2 rounded-xl border-2 text-[10px] font-black transition ${current.call.name === o.n ? 'border-slate-800 bg-slate-50' : 'bg-slate-50 border-transparent text-slate-400'}`}>{o.n} ¥{o.p}</button>
                                    ))}
                                </div>
                            </div>
                        </section>

                        {/* Step 4: Discounts */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 text-left">
                            <h2 className="text-[11px] font-black text-slate-400 mb-4 uppercase tracking-widest flex items-center gap-2">
                                <div className="w-1.5 h-3 bg-blue-600 rounded-full"></div> Step 4. 各種割引
                            </h2>
                            <div className="space-y-2">
                                {current.discounts.map(d => (
                                    <div key={d.id} className={`flex items-center gap-2 p-3 rounded-2xl border transition ${d.active ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-transparent'}`}>
                                        <button onClick={() => updateState('discounts', current.discounts.map(x => x.id === d.id ? {...x, active: !x.active} : x))}>
                                            <Icon name={d.active ? "check-circle-2" : "circle"} className={d.active ? 'text-emerald-500' : 'text-slate-300'} />
                                        </button>
                                        <span className="flex-1 text-xs font-black">{d.name}</span>
                                        <div className="flex items-center gap-1 font-black text-xs text-slate-400">-¥<input type="number" value={d.amount} onChange={e => updateState('discounts', current.discounts.map(x => x.id === d.id ? {...x, amount: Number(e.target.value)} : x))} className="w-16 bg-white border rounded px-1.5 py-0.5 text-slate-900 text-right" /></div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* Step 5 & 6: Upfront & Points */}
                        <div className="grid grid-cols-2 gap-4 text-left">
                            <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-2">
                                <h2 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Step 5. 頭金</h2>
                                <button onClick={() => updateState('device.hasDownPayment', !current.device.hasDownPayment)} className={`w-full p-3 rounded-2xl border-2 font-black text-[10px] ${current.device.hasDownPayment ? 'border-rose-500 bg-rose-50 text-rose-600' : 'bg-slate-50 border-transparent text-slate-400'}`}>頭金 ¥11,000</button>
                            </section>
                            <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-2">
                                <h2 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Step 6. ポイント</h2>
                                <div className="flex items-center bg-blue-50 p-3 rounded-2xl border border-blue-100">
                                    <input type="number" value={current.points[0].amount} onChange={e => updateState('points', [{...current.points[0], amount: Number(e.target.value)}])} className="w-full bg-transparent text-sm font-black text-blue-600 focus:outline-none" />
                                    <span className="text-[10px] font-black text-blue-400 ml-1 whitespace-nowrap">pt還元</span>
                                </div>
                            </section>
                        </div>
                    </main>

                    <footer className="fixed bottom-0 inset-x-0 bg-white/80 backdrop-blur-xl border-t p-5 pb-8 z-50 shadow-2xl">
                        <div className="max-w-2xl mx-auto flex justify-between items-end">
                            <div className="text-left">
                                <p className="text-[10px] font-black text-slate-400 tracking-widest uppercase">案{activeSlot} 月額目安</p>
                                <p className="text-4xl font-black italic">¥{calc.monthlyTotal.toLocaleString()}<span className="text-[10px] font-bold not-italic ml-1">/月(税込)</span></p>
                            </div>
                            <button onClick={() => setShowSummary(true)} className="bg-slate-900 text-white px-8 py-4 rounded-[2rem] font-black text-sm shadow-xl active:scale-95 transition">見積詳細</button>
                        </div>
                    </footer>

                    {/* Summary Modal */}
                    {showSummary && (
                        <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-end justify-center p-0">
                            <div className="bg-white w-full max-w-lg rounded-t-[3rem] max-h-[92vh] flex flex-col shadow-2xl animate-in slide-in-from-bottom duration-300">
                                <div className="p-6 border-b flex justify-between items-center text-left">
                                    <h2 className="text-lg font-black flex items-center gap-2"><Icon name="clipboard-list" className="text-blue-600" /> お見積もり確認</h2>
                                    <button onClick={() => setShowSummary(false)} className="p-2 bg-slate-100 rounded-full"><Icon name="x" className="w-5 h-5" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 space-y-6 text-left">
                                    <div className="bg-slate-900 text-white rounded-[2.5rem] p-8 text-center space-y-2">
                                        <p className="text-[10px] font-bold opacity-50 tracking-[0.3em] uppercase">Monthly Total</p>
                                        <p className="text-6xl font-black italic">¥{calc.monthlyTotal.toLocaleString()}</p>
                                        <p className="text-xs opacity-70 border-t border-white/10 pt-4 font-bold">{current.device.name} | {current.device.installments}回払い</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-slate-50 p-5 rounded-3xl border text-center">
                                            <p className="text-[10px] font-black text-slate-400 mb-1">本日お支払</p>
                                            <p className="text-2xl font-black">¥{calc.upfront.toLocaleString()}</p>
                                        </div>
                                        <div className="bg-blue-50 p-5 rounded-3xl border border-blue-100 text-center">
                                            <p className="text-[10px] font-black text-blue-400 mb-1">ポイント還元</p>
                                            <p className="text-2xl font-black text-blue-600">{calc.totalPoints.toLocaleString()} pt</p>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 rounded-[2.5rem] p-7 space-y-4">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-3 text-center">重要事項説明チェック</p>
                                        {[
                                            { k: 'i', l: `${current.device.installments}回分割/月額¥${calc.devMonthly.toLocaleString()}` },
                                            { k: 'r', l: `2年後返却による残価(¥${calc.residual.toLocaleString()})免除の仕組み` },
                                            { k: 'c', l: `契約事務手数料(¥3,850)が翌月合算されること` },
                                            { k: 'p', l: `初期費用とポイント還元条件の最終確認` }
                                        ].map(item => (
                                            <button key={item.k} onClick={() => setChecklist(p => ({...p, [item.k]: !p[item.k]}))} className="flex items-start gap-3 w-full group">
                                                <Icon name={checklist[item.k] ? "check-square" : "square"} className={`w-5 h-5 shrink-0 ${checklist[item.k] ? 'text-blue-600' : 'text-slate-300'}`} />
                                                <span className={`text-[11px] font-bold ${checklist[item.k] ? 'text-slate-900' : 'text-slate-500'}`}>{item.l}</span>
                                            </button>
                                        ))}
                                    </div>
                                    <button 
                                        disabled={!Object.values(checklist).every(v => v)}
                                        onClick={() => setShowSummary(false)}
                                        className={`w-full py-5 rounded-3xl font-black text-sm transition-all ${Object.values(checklist).every(v => v) ? 'bg-blue-600 text-white shadow-xl' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
                                    >
                                        説明を完了する
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
