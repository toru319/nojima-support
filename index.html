<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Support Pro - Nojima Ver.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'sans-serif'; -webkit-tap-highlight-color: transparent; }
        /* タップ領域を確保 */
        .touch-target { min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // アイコンコンポーネント
        const Icon = ({ name, className = "w-4 h-4", ...props }) => {
            const iconRef = React.useRef(null);
            useEffect(() => {
                lucide.createIcons();
            }, [name, className]);
            return <i data-lucide={name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase()} className={className} {...props}></i>;
        };

        const CheckCircle = (p) => <Icon name="CheckCircle" {...p} />;
        const RefreshCcw = (p) => <Icon name="RefreshCcw" {...p} />;
        const PlusCircle = (p) => <Icon name="PlusCircle" {...p} />;
        const SmartphoneNfc = (p) => <Icon name="SmartphoneNfc" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const CheckSquare = (p) => <Icon name="CheckSquare" {...p} />;
        const Square = (p) => <Icon name="Square" {...p} />;
        const Wallet = (p) => <Icon name="Wallet" {...p} />;
        const Gift = (p) => <Icon name="Gift" {...p} />;
        const FileText = (p) => <Icon name="FileText" {...p} />;
        const Layers = (p) => <Icon name="Layers" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const AlertTriangle = (p) => <Icon name="AlertTriangle" {...p} />;

        const CARRIER_DATA = {
          docomo: {
            name: "docomo", type: "main", color: "bg-rose-600",
            programName: "いつでもカエドキプログラム",
            programBenefitNote: "【特典利用料】22,000円。23ヶ月目に返却する際、別途支払いが必要となります。",
            hasProgramFee: true,
            plans: [{ name: "ドコモ MAX", price: 8448 }, { name: "ahamo", price: 2970 }],
            callOptions: [{ name: "なし", price: 0 }, { name: "5分無料", price: 880 }, { name: "かけ放題", price: 1980 }]
          },
          au: {
            name: "au", type: "main", color: "bg-orange-500",
            programName: "スマホトクするプログラム",
            programBenefitNote: "【特典利用料】22,000円。23ヶ月目に返却する際、別途支払いが必要となります。",
            hasProgramFee: true,
            plans: [{ name: "auバリューリンク", price: 8008 }, { name: "スマホミニ", price: 4928 }],
            callOptions: [{ name: "なし", price: 0 }, { name: "通話ライト", price: 880 }, { name: "通話定額", price: 1980 }]
          },
          softbank: {
            name: "SoftBank", type: "main", color: "bg-slate-800",
            programName: "新トクするサポート",
            programBenefitNote: "【特典利用料】22,000円。条件により、返却時に利用料が発生します。",
            hasProgramFee: true,
            plans: [{ name: "ペイトク無制限", price: 9625 }, { name: "メリハリ無制限+", price: 7425 }],
            callOptions: [{ name: "なし", price: 0 }, { name: "準定額+", price: 880 }, { name: "定額+", price: 1980 }]
          },
          uq: {
            name: "UQ mobile", type: "sub", color: "bg-blue-600",
            programName: "スマホトクするプログラム",
            programBenefitNote: "【特典利用料】なし。23ヶ月目に返却で残価免除。",
            hasProgramFee: false,
            plans: [{ name: "コミコミバリュー", price: 3828 }, { name: "トクトク2", price: 4048 }],
            callOptions: [{ name: "なし", price: 0 }, { name: "放題ライト", price: 880 }, { name: "放題", price: 1980 }]
          },
          ymobile: {
            name: "Y!mobile", type: "sub", color: "bg-red-500",
            programName: "新トクするサポート",
            programBenefitNote: "【特典利用料】なし。23ヶ月目に返却で残価免除。",
            hasProgramFee: false,
            plans: [{ name: "シンプル3 S", price: 3058 }, { name: "シンプル3 M", price: 4158 }],
            callOptions: [{ name: "なし", price: 0 }, { name: "だれ定+", price: 880 }, { name: "だれ定+ S", price: 1980 }]
          }
        };

        const DEFAULT_SLOT_STATE = {
          carrier: 'docomo',
          device: { name: 'iPhone 17', price: 134800, installments: 48, first24Monthly: 1, hasDownPayment: false, manualMode: false },
          plan: { name: 'ドコモ MAX', price: 8448 },
          callOption: { name: 'なし', price: 0 },
          transferService: { name: 'なし', price: 0 },
          discounts: [
            { id: 1, name: '家族割 (3回線以上)', amount: 1100, active: false },
            { id: 2, name: 'セット割 (光/Air)', amount: 1100, active: false }
          ],
          nojimaPoints: [
            { id: 101, name: 'オプション加入', amount: 11000, active: true }
          ]
        };

        const App = () => {
          const [activeSlot, setActiveSlot] = useState('A'); 
          const [isComparisonMode, setIsComparisonMode] = useState(false);
          const [slots, setSlots] = useState({
            A: JSON.parse(JSON.stringify(DEFAULT_SLOT_STATE)),
            B: { ...JSON.parse(JSON.stringify(DEFAULT_SLOT_STATE)), carrier: 'uq', plan: { name: 'コミコミバリュー', price: 3828 } }
          });
          const [showSummary, setShowSummary] = useState(false);
          const [summaryActiveSlot, setSummaryActiveSlot] = useState('A');
          const [checklist, setChecklist] = useState({ installments: false, residual: false, fees: false, downpayment: false });

          const state = slots[activeSlot];
          const currentCarrier = CARRIER_DATA[state.carrier];

          const updateSlot = (slotKey, field, value) => {
            setSlots(prev => ({ ...prev, [slotKey]: { ...prev[slotKey], [field]: value } }));
          };

          const handleCarrierChange = (key) => {
            const data = CARRIER_DATA[key];
            const updatedSlot = {
              ...state,
              carrier: key,
              plan: { name: data.plans[0].name, price: data.plans[0].price },
              callOption: { name: data.callOptions[0].name, price: data.callOptions[0].price }
            };
            setSlots(prev => ({ ...prev, [activeSlot]: updatedSlot }));
          };

          const calculateResults = (slotData) => {
            const downPayment = slotData.device.hasDownPayment ? 11000 : 0;
            let monthlyDevice = 0;
            let residual = 0;
            if (slotData.device.installments === 48) {
              monthlyDevice = slotData.device.first24Monthly;
              residual = slotData.device.price - (slotData.device.first24Monthly * 23);
            } else if (slotData.device.installments > 1) {
              monthlyDevice = Math.floor(slotData.device.price / slotData.device.installments);
            }
            const totalDiscounts = slotData.discounts.reduce((sum, d) => d.active ? sum + Number(d.amount) : sum, 0);
            const monthlyTotal = (monthlyDevice + slotData.plan.price + slotData.callOption.price) - totalDiscounts;
            const initialTotal = downPayment + slotData.transferService.price;
            const totalPoints = slotData.nojimaPoints.reduce((sum, p) => p.active ? sum + Number(p.amount) : sum, 0);
            return { monthlyTotal, monthlyDevice, residual, initialTotal, totalPoints };
          };

          const results = useMemo(() => ({ A: calculateResults(slots.A), B: calculateResults(slots.B) }), [slots]);

          const addEntry = (field, name, defaultAmount) => {
            updateSlot(activeSlot, field, [...state[field], { id: Date.now(), name, amount: defaultAmount, active: true }]);
          };

          const updateEntry = (field, id, key, value) => {
            updateSlot(activeSlot, field, state[field].map(item => item.id === id ? { ...item, [key]: value } : item));
          };

          // 削除機能の本体
          const removeEntry = (field, id) => {
            updateSlot(activeSlot, field, state[field].filter(item => item.id !== id));
          };

          return (
            <div className="min-h-screen bg-slate-50 text-slate-900 pb-36">
              <header className={`${isComparisonMode ? 'bg-[#002B6B]' : currentCarrier.color} text-white p-4 sticky top-0 z-50 shadow-lg`}>
                <div className="max-w-2xl mx-auto flex justify-between items-center">
                  <div className="flex items-center gap-2">
                    <SmartphoneNfc className="w-5 h-5" />
                    <h1 className="font-bold text-sm">Sales Support Pro <span className="text-[10px] opacity-75">Nojima</span></h1>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => setIsComparisonMode(!isComparisonMode)} className={`px-3 py-1.5 rounded-full text-[10px] font-black border ${isComparisonMode ? 'bg-white text-blue-900' : 'bg-transparent border-white/40'}`}>
                      比較: {isComparisonMode ? 'ON' : 'OFF'}
                    </button>
                    <button onClick={() => window.location.reload()} className="p-1.5 bg-white/10 rounded-full"><RefreshCcw className="w-4 h-4" /></button>
                  </div>
                </div>
              </header>

              {isComparisonMode && (
                <div className="bg-white border-b sticky top-[52px] z-40 p-1 flex max-w-2xl mx-auto">
                    {['A', 'B'].map(s => (
                      <button key={s} onClick={() => setActiveSlot(s)} className={`flex-1 py-2 text-xs font-black rounded-xl transition ${activeSlot === s ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400'}`}>
                        案 {s} <span className="opacity-80">¥{results[s].monthlyTotal.toLocaleString()}</span>
                      </button>
                    ))}
                </div>
              )}

              <main className="max-w-2xl mx-auto p-4 space-y-4">
                <section className="bg-white rounded-2xl p-4 shadow-sm border">
                  <h2 className="text-[10px] font-black text-slate-400 mb-4 uppercase">Step 1. キャリア</h2>
                  <div className="grid grid-cols-3 gap-2 mb-2">
                    {Object.keys(CARRIER_DATA).map(key => CARRIER_DATA[key].type === 'main' && (
                      <button key={key} onClick={() => handleCarrierChange(key)} className={`py-3 rounded-xl border-2 font-bold text-[11px] ${state.carrier === key ? `${CARRIER_DATA[key].color} border-transparent text-white` : 'bg-slate-50 text-slate-400 border-transparent'}`}>
                        {CARRIER_DATA[key].name}
                      </button>
                    ))}
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    {Object.keys(CARRIER_DATA).map(key => CARRIER_DATA[key].type === 'sub' && (
                      <button key={key} onClick={() => handleCarrierChange(key)} className={`py-3 rounded-xl border-2 font-bold text-[11px] ${state.carrier === key ? `${CARRIER_DATA[key].color} border-transparent text-white` : 'bg-slate-50 text-slate-400 border-transparent'}`}>
                        {CARRIER_DATA[key].name}
                      </button>
                    ))}
                  </div>
                </section>

                <section className="bg-white rounded-2xl p-4 shadow-sm border space-y-4">
                  <div className="flex justify-between items-center"><h2 className="text-[10px] font-black text-slate-400">Step 2. 端末設定</h2></div>
                  <div className="grid grid-cols-2 gap-x-4">
                    <input type="text" value={state.device.name} onChange={(e) => updateSlot(activeSlot, 'device', {...state.device, name: e.target.value})} className="h-11 px-3 bg-slate-50 rounded-xl text-xs font-bold ring-1 ring-slate-200" />
                    <input type="number" value={state.device.price} onChange={(e) => updateSlot(activeSlot, 'device', {...state.device, price: Number(e.target.value)})} className="h-11 px-3 bg-slate-50 rounded-xl text-xs font-bold text-right ring-1 ring-slate-200" />
                  </div>
                  <div className="flex bg-slate-100 p-1 rounded-xl">
                    {[1, 24, 36, 48].map(n => (
                      <button key={n} onClick={() => updateSlot(activeSlot, 'device', {...state.device, installments: n})} className={`flex-1 py-2 rounded-lg text-[10px] font-black ${state.device.installments === n ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}>
                        {n === 1 ? '一括' : `${n}回`}
                      </button>
                    ))}
                  </div>
                  {state.device.installments === 48 && (
                    <div className="bg-blue-50/50 p-4 rounded-xl border border-blue-100 flex justify-between">
                      <div><span className="text-[9px] text-blue-400 font-black">23ヶ月目までの月額</span><input type="number" value={state.device.first24Monthly} onChange={(e) => updateSlot(activeSlot, 'device', {...state.device, first24Monthly: Number(e.target.value)})} className="w-24 p-2 bg-white rounded-lg border text-sm font-black text-blue-600 block" /></div>
                      <div className="text-right"><span className="text-[9px] text-blue-400 font-black">25ヶ月目以降(免除額)</span><p className="text-sm font-black text-slate-500 italic">¥{results[activeSlot].residual.toLocaleString()}</p></div>
                    </div>
                  )}
                </section>

                {/* Step 4. 各種割引 */}
                <section className="bg-white rounded-2xl p-4 shadow-sm border">
                  <div className="flex justify-between items-center mb-3">
                    <h2 className="text-[10px] font-black text-slate-400">Step 4. 各種割引</h2>
                    <button onClick={() => addEntry('discounts', '新規割引', 0)} className="text-emerald-600 bg-emerald-50 p-1 rounded-lg"><PlusCircle className="w-4 h-4" /></button>
                  </div>
                  <div className="space-y-2">
                    {state.discounts.map(d => (
                      <div key={d.id} className={`flex items-center gap-2 p-3 rounded-xl border ${d.active ? 'border-emerald-200 bg-emerald-50/30' : 'bg-slate-50'}`}>
                        <button onClick={() => updateEntry('discounts', d.id, 'active', !d.active)} className={d.active ? 'text-emerald-500' : 'text-slate-300'}>
                            {d.active ? <CheckSquare className="w-5 h-5 fill-current bg-white rounded" /> : <Square className="w-5 h-5" />}
                        </button>
                        <input type="text" value={d.name} onChange={(e) => updateEntry('discounts', d.id, 'name', e.target.value)} className="flex-1 bg-transparent text-[11px] font-bold border-0 p-0" />
                        <input type="number" value={d.amount} onChange={(e) => updateEntry('discounts', d.id, 'amount', Number(e.target.value))} className="w-16 bg-white rounded px-2 py-1 text-xs font-black text-right border" />
                        {/* 削除ボタン */}
                        <button onClick={() => removeEntry('discounts', d.id)} className="text-slate-400 hover:text-red-500 p-1 ml-1 transition-colors">
                            <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>
                </section>

                <section className="bg-white rounded-2xl p-4 shadow-sm border">
                  <h2 className="text-[10px] font-black text-slate-400 mb-3">Step 5. 初期費用</h2>
                  <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => updateSlot(activeSlot, 'device', {...state.device, hasDownPayment: !state.device.hasDownPayment})} className={`p-3 rounded-xl border-2 font-bold text-[11px] ${state.device.hasDownPayment ? 'border-rose-500 bg-rose-50 text-rose-600' : 'bg-slate-50 text-slate-400 border-transparent'}`}>店頭頭金 ¥11,000</button>
                    <select value={state.transferService.price} onChange={(e) => updateSlot(activeSlot, 'transferService', { name: "データ移行", price: Number(e.target.value) })} className="p-3 rounded-xl bg-slate-50 text-[11px] font-bold border-2 border-transparent">
                      <option value="0">データ移行なし</option>
                      <option value="15000">同OS移行 ¥15,000</option>
                      <option value="20000">異OS移行 ¥20,000</option>
                    </select>
                  </div>
                </section>

                {/* Step 6. ノジマポイント */}
                <section className="bg-white rounded-2xl p-4 shadow-sm border">
                  <div className="flex justify-between items-center mb-3">
                    <h2 className="text-[10px] font-black text-slate-400">Step 6. ノジマポイント</h2>
                    <button onClick={() => addEntry('nojimaPoints', '新規特典', 0)} className="text-blue-600 bg-blue-50 p-1 rounded-lg"><PlusCircle className="w-4 h-4" /></button>
                  </div>
                  <div className="space-y-2">
                    {state.nojimaPoints.map(p => (
                      <div key={p.id} className={`flex items-center gap-2 p-3 rounded-xl border ${p.active ? 'border-blue-200 bg-blue-50/30' : 'bg-slate-50'}`}>
                        <button onClick={() => updateEntry('nojimaPoints', p.id, 'active', !p.active)} className={p.active ? 'text-blue-500' : 'text-slate-300'}>
                          {p.active ? <CheckSquare className="w-5 h-5 fill-current bg-white rounded" /> : <Square className="w-5 h-5" />}
                        </button>
                        <input type="text" value={p.name} onChange={(e) => updateEntry('nojimaPoints', p.id, 'name', e.target.value)} className="flex-1 bg-transparent text-[11px] font-bold border-0 p-0" />
                        <input type="number" value={p.amount} onChange={(e) => updateEntry('nojimaPoints', p.id, 'amount', Number(e.target.value))} className="w-20 bg-white rounded px-2 py-1 text-xs font-black text-right border" />
                        <span className="text-[10px] font-bold text-slate-400">pt</span>
                        {/* 削除ボタン */}
                        <button onClick={() => removeEntry('nojimaPoints', p.id)} className="text-slate-400 hover:text-red-500 p-1 ml-1 transition-colors">
                            <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>
                </section>
              </main>

              <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t p-4 pb-8 z-50 shadow-2xl">
                <div className="max-w-2xl mx-auto flex items-center justify-between">
                  <div className="flex-1">
                    <p className="text-[9px] font-black text-slate-400 uppercase mb-1">月額目安 (案{activeSlot})</p>
                    <p className="text-3xl font-black text-slate-900 leading-none">¥{results[activeSlot].monthlyTotal.toLocaleString()}<span className="text-xs font-medium ml-1">/月</span></p>
                  </div>
                  <button onClick={() => { setShowSummary(true); setSummaryActiveSlot(activeSlot); }} className="bg-slate-900 text-white px-10 py-3.5 rounded-2xl font-black text-sm flex items-center gap-2">
                    <FileText className="w-4 h-4" /> 見積詳細
                  </button>
                </div>
              </div>

              {showSummary && (
                <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-end sm:items-center justify-center">
                  <div className="bg-white w-full max-w-lg rounded-t-[2.5rem] sm:rounded-3xl max-h-[96vh] overflow-hidden flex flex-col shadow-2xl">
                    <div className="p-6 border-b flex justify-between items-center bg-slate-50/50">
                      <h2 className="text-lg font-black flex items-center gap-2"><Layers className="w-5 h-5 text-blue-600" /> お見積もり内容</h2>
                      <button onClick={() => setShowSummary(false)} className="p-2 bg-white rounded-full border shadow-sm"><X className="w-5 h-5" /></button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-8 space-y-8 bg-white pb-24 text-left">
                      <div className="bg-slate-900 text-white rounded-[2rem] p-8 text-center">
                        <p className="text-[10px] font-bold opacity-60 mb-2 tracking-widest uppercase">Monthly Total</p>
                        <p className="text-5xl font-black">¥{results[summaryActiveSlot].monthlyTotal.toLocaleString()}<span className="text-xs font-normal">/月</span></p>
                      </div>

                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between"><span>機種: {slots[summaryActiveSlot].device.name}</span><span className="font-black">¥{results[summaryActiveSlot].monthlyDevice.toLocaleString()}</span></div>
                        <div className="flex justify-between border-b pb-2"><span>プラン: {slots[summaryActiveSlot].plan.name}</span><span className="font-black">¥{slots[summaryActiveSlot].plan.price.toLocaleString()}</span></div>
                        {slots[summaryActiveSlot].discounts.filter(d => d.active).map(d => (
                          <div key={d.id} className="flex justify-between text-emerald-600 font-bold"><span>{d.name}</span><span>-¥{d.amount.toLocaleString()}</span></div>
                        ))}
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div className="bg-slate-50 rounded-2xl p-4 border text-left">
                          <p className="text-[10px] font-black text-slate-400 mb-1 uppercase">本日店頭払</p>
                          <p className="text-xl font-black">¥{results[summaryActiveSlot].initialTotal.toLocaleString()}</p>
                        </div>
                        <div className="bg-blue-50/50 rounded-2xl p-4 border border-blue-100 text-left">
                          <p className="text-[10px] font-black text-blue-400 mb-1 uppercase">ノジマpt還元</p>
                          <p className="text-xl font-black text-blue-600">{results[summaryActiveSlot].totalPoints.toLocaleString()} pt</p>
                        </div>
                      </div>

                      <div className="flex gap-3">
                        <button onClick={() => window.print()} className="flex-1 py-4 bg-slate-100 rounded-2xl font-black text-slate-600">画面保存</button>
                        <button onClick={() => setShowSummary(false)} className="flex-[2] py-4 rounded-2xl font-black bg-blue-600 text-white">説明を完了する</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
