<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Support Pro (Nojima Edition)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, className }) => {
            useEffect(() => { lucide.createIcons(); });
            return <i data-lucide={name} className={className}></i>;
        };

        const CARRIER_DATA = {
            docomo: { name: "docomo", type: "main", color: "bg-rose-600", program: "いつでもカエドキプログラム", hasFee: true },
            au: { name: "au", type: "main", color: "bg-orange-500", program: "スマホトクするプログラム", hasFee: true },
            softbank: { name: "SoftBank", type: "main", color: "bg-slate-800", program: "新トクするサポート", hasFee: true },
            uq: { name: "UQ mobile", type: "sub", color: "bg-blue-600", program: "スマホトクするプログラム", hasFee: false },
            ymobile: { name: "Y!mobile", type: "sub", color: "bg-red-500", program: "新トクするサポート", hasFee: false }
        };

        const PLAN_PRESETS = {
            docomo: [{ n: "ドコモ MAX", p: 8448 }, { n: "ドコモ mini (4GB)", p: 2500 }, { n: "ahamo", p: 2970 }],
            au: [{ n: "auバリューリンク", p: 8008 }, { n: "スマホミニプラン", p: 4928 }],
            softbank: [{ n: "ペイトク無制限", p: 9625 }, { n: "メリハリ無制限＋", p: 7425 }, { n: "スマホデビュー", p: 1078 }],
            uq: [{ n: "コミコミバリュー", p: 3828 }, { n: "トクトクプラン2", p: 4048 }],
            ymobile: [{ n: "シンプル3 S", p: 3058 }, { n: "シンプル3 M", p: 4158 }, { n: "シンプル3 L", p: 5258 }]
        };

        const createInitialState = (carrier) => ({
            carrier,
            device: { name: 'iPhone 17', price: 134800, installments: 48, monthly: 1, hasDownPayment: true },
            plan: { name: PLAN_PRESETS[carrier][0].n, price: PLAN_PRESETS[carrier][0].p },
            call: { name: 'なし', price: 0 },
            transfer: 0,
            discounts: [
                { id: 1, name: '家族割 (3回線)', amount: 1100, active: false },
                { id: 2, name: 'セット割 (光/Air)', amount: 1100, active: false }
            ],
            points: [{ id: 101, name: 'オプション加入特典', amount: 11000, active: true }]
        });

        const App = () => {
            const [activeSlot, setActiveSlot] = useState('A');
            const [slots, setSlots] = useState({ A: createInitialState('docomo'), B: createInitialState('uq') });
            const [showSummary, setShowSummary] = useState(false);
            const [checklist, setChecklist] = useState({ i: false, r: false, f: false, c: false, p: false });

            const current = slots[activeSlot];
            const carrier = CARRIER_DATA[current.carrier];

            // リアルタイム計算ロジック
            const calc = useMemo(() => {
                const s = current;
                let devMonthly = 0;
                let residual = 0;

                if (s.device.installments === 48) {
                    devMonthly = Number(s.device.monthly);
                    residual = Number(s.device.price) - (devMonthly * 23);
                } else if (s.device.installments > 1) {
                    devMonthly = Math.floor(Number(s.device.price) / Number(s.device.installments));
                }

                const totalDisc = s.discounts.reduce((acc, d) => d.active ? acc + Number(d.amount) : acc, 0);
                const monthlyTotal = devMonthly + Number(s.plan.price) + Number(s.call.price) - totalDisc;
                const upfront = (s.device.hasDownPayment ? 11000 : 0) + Number(s.transfer) + (s.device.installments === 1 ? Number(s.device.price) : 0);
                const totalPoints = s.points.reduce((acc, p) => p.active ? acc + Number(p.amount) : acc, 0);

                return { devMonthly, residual, monthlyTotal, upfront, totalPoints };
            }, [current]);

            // ステート更新用ヘルパー（不変性を維持）
            const updateState = (category, updates) => {
                setSlots(prev => ({
                    ...prev,
                    [activeSlot]: {
                        ...prev[activeSlot],
                        [category]: { ...prev[activeSlot][category], ...updates }
                    }
                }));
            };

            const isAllChecked = useMemo(() => {
                const needsProgramFee = current.device.installments === 48 && carrier.hasFee;
                return checklist.i && checklist.r && checklist.c && checklist.p && (!needsProgramFee || checklist.f);
            }, [checklist, current, carrier]);

            return (
                <div className="min-h-screen pb-40">
                    <header className={`${carrier.color} text-white p-4 sticky top-0 z-50 shadow-md transition-colors duration-300`}>
                        <div className="max-w-2xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Icon name="smartphone" className="w-5 h-5" />
                                <h1 className="font-black text-sm tracking-tight italic">Sales Support Pro <span className="text-[10px] font-normal not-italic opacity-80 text-white/70">Nojima Ed.</span></h1>
                            </div>
                            <div className="flex bg-white/20 p-1 rounded-xl">
                                {['A', 'B'].map(s => (
                                    <button key={s} onClick={() => setActiveSlot(s)} className={`px-4 py-1.5 rounded-lg text-xs font-black transition ${activeSlot === s ? 'bg-white text-slate-900 shadow-sm' : 'text-white hover:bg-white/10'}`}>案 {s}</button>
                                ))}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-2xl mx-auto p-4 space-y-4 text-left">
                        {/* Step 1: Carrier */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                            <h2 className="text-[11px] font-black text-slate-400 mb-4 flex items-center gap-2"><div className="w-1.5 h-3 bg-blue-600 rounded-full"></div>STEP 1. キャリア選択</h2>
                            <div className="grid grid-cols-3 gap-2 mb-2">
                                {Object.entries(CARRIER_DATA).filter(([_, v]) => v.type === 'main').map(([k, v]) => (
                                    <button key={k} onClick={() => setSlots(prev => ({...prev, [activeSlot]: createInitialState(k)}))} className={`py-3 rounded-2xl border-2 font-bold text-xs transition-all ${current.carrier === k ? `${v.color} border-transparent text-white shadow-lg` : 'bg-slate-50 border-slate-50 text-slate-400'}`}>{v.name}</button>
                                ))}
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                {Object.entries(CARRIER_DATA).filter(([_, v]) => v.type === 'sub').map(([k, v]) => (
                                    <button key={k} onClick={() => setSlots(prev => ({...prev, [activeSlot]: createInitialState(k)}))} className={`py-3 rounded-2xl border-2 font-bold text-xs transition-all ${current.carrier === k ? `${v.color} border-transparent text-white shadow-lg` : 'bg-slate-50 border-slate-50 text-slate-400'}`}>{v.name}</button>
                                ))}
                            </div>
                        </section>

                        {/* Step 2: Device */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-4">
                            <h2 className="text-[11px] font-black text-slate-400 flex items-center gap-2"><div className="w-1.5 h-3 bg-blue-600 rounded-full"></div>STEP 2. 端末・割賦設定</h2>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="space-y-1">
                                    <span className="text-[10px] font-bold text-slate-400 ml-1">機種名</span>
                                    <input type="text" value={current.device.name} onChange={e => updateState('device', {name: e.target.value})} className="w-full p-3 bg-slate-50 rounded-2xl text-xs font-black" />
                                </div>
                                <div className="space-y-1">
                                    <span className="text-[10px] font-bold text-slate-400 ml-1">端末総額 (税込)</span>
                                    <input type="number" value={current.device.price} onChange={e => updateState('device', {price: e.target.value})} className="w-full p-3 bg-slate-50 rounded-2xl text-xs font-black text-right" />
                                </div>
                            </div>
                            <div className="flex bg-slate-100 p-1.5 rounded-2xl">
                                {[1, 24, 36, 48].map(n => (
                                    <button key={n} onClick={() => updateState('device', {installments: n})} className={`flex-1 py-2 rounded-xl text-[10px] font-black transition ${current.device.installments === n ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400'}`}>{n === 1 ? '一括' : `${n}回`}</button>
                                ))}
                            </div>
                            {current.device.installments === 48 && (
                                <div className="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex justify-between items-center">
                                    <div className="space-y-1">
                                        <span className="text-[9px] font-black text-blue-400 uppercase">23ヶ月目までの月額</span>
                                        <input type="number" value={current.device.monthly} onChange={e => updateState('device', {monthly: e.target.value})} className="w-24 p-2 bg-white rounded-lg border border-blue-200 text-sm font-black text-blue-600" />
                                    </div>
                                    <div className="text-right">
                                        <span className="text-[9px] font-black text-slate-400 uppercase">25ヶ月目以降(免除額)</span>
                                        <p className="text-lg font-black text-slate-700 italic">¥{calc.residual.toLocaleString()}</p>
                                    </div>
                                </div>
                            )}
                        </section>

                        {/* Step 3: Plan */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-4">
                            <h2 className="text-[11px] font-black text-slate-400 flex items-center gap-2"><div className="w-1.5 h-3 bg-blue-600 rounded-full"></div>STEP 3. 通信プラン</h2>
                            <div className="grid grid-cols-2 gap-3">
                                <div className="col-span-2 space-y-1">
                                    <span className="text-[10px] font-bold text-slate-400 ml-1">プラン選択・編集</span>
                                    <div className="flex gap-2">
                                        <input type="text" value={current.plan.name} onChange={e => updateState('plan', {name: e.target.value})} className="flex-1 p-3 bg-slate-50 rounded-2xl text-xs font-black" />
                                        <select onChange={e => { const p = PLAN_PRESETS[current.carrier][e.target.value]; if(p) updateState('plan', {name: p.n, price: p.p}) }} className="w-20 p-3 bg-white border border-slate-200 rounded-2xl text-[10px] font-bold">
                                            <option value="">履歴</option>
                                            {PLAN_PRESETS[current.carrier].map((p, i) => <option key={i} value={i}>{p.n}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div className="col-span-2 space-y-1">
                                    <span className="text-[10px] font-bold text-slate-400 ml-1">プラン料金 (月額)</span>
                                    <input type="number" value={current.plan.price} onChange={e => updateState('plan', {price: e.target.value})} className="w-full p-3 bg-slate-50 rounded-2xl text-xs font-black" />
                                </div>
                            </div>
                            <div className="grid grid-cols-3 gap-2 pt-2 border-t">
                                {[ {n:'なし', p:0}, {n:'5分無料', p:880}, {n:'かけ放題', p:1980} ].map(o => (
                                    <button key={o.n} onClick={() => updateState('call', {name:o.n, price:o.p})} className={`p-2 rounded-2xl border-2 text-[10px] font-black transition ${current.call.name === o.n ? 'border-slate-800 bg-slate-50' : 'bg-slate-50 border-transparent text-slate-400'}`}>{o.n}<span className="block opacity-60">¥{o.p}</span></button>
                                ))}
                            </div>
                        </section>

                        {/* Step 4: Discounts */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-[11px] font-black text-slate-400 flex items-center gap-2"><div className="w-1.5 h-3 bg-blue-600 rounded-full"></div>STEP 4. 各種割引</h2>
                                <button onClick={() => setSlots(prev => ({...prev, [activeSlot]: {...current, discounts: [...current.discounts, {id: Date.now(), name: '新規割引', amount: 0, active: true}]}}))} className="text-emerald-600 bg-emerald-50 p-1 rounded-lg"><Icon name="plus" className="w-4 h-4" /></button>
                            </div>
                            <div className="space-y-2">
                                {current.discounts.map(d => (
                                    <div key={d.id} className={`flex items-center gap-2 p-3 rounded-2xl border transition ${d.active ? 'bg-emerald-50/40 border-emerald-200' : 'bg-slate-50 border-transparent'}`}>
                                        <button onClick={() => setSlots(prev => ({...prev, [activeSlot]: {...current, discounts: current.discounts.map(x => x.id === d.id ? {...x, active: !x.active} : x)}}))}><Icon name={d.active ? "check-circle" : "circle"} className={`w-5 h-5 ${d.active ? 'text-emerald-500' : 'text-slate-300'}`} /></button>
                                        <input type="text" value={d.name} onChange={e => setSlots(prev => ({...prev, [activeSlot]: {...current, discounts: current.discounts.map(x => x.id === d.id ? {...x, name: e.target.value} : x)}}))} className="flex-1 bg-transparent text-[11px] font-bold border-none p-0 focus:ring-0" />
                                        <div className="flex items-center gap-1">
                                            <span className="text-[10px] font-black text-slate-400">-¥</span>
                                            <input type="number" value={d.amount} onChange={e => setSlots(prev => ({...prev, [activeSlot]: {...current, discounts: current.discounts.map(x => x.id === d.id ? {...x, amount: e.target.value} : x)}}))} className="w-16 bg-white border rounded px-1.5 py-0.5 text-xs font-black text-right" />
                                        </div>
                                        <button onClick={() => setSlots(prev => ({...prev, [activeSlot]: {...current, discounts: current.discounts.filter(x => x.id !== d.id)}}))} className="text-slate-300"><Icon name="x" className="w-4 h-4" /></button>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* Step 5: Upfront Payment */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                            <h2 className="text-[11px] font-black text-slate-400 mb-4 flex items-center gap-2"><div className="w-1.5 h-3 bg-blue-600 rounded-full"></div>STEP 5. 本日のお支払い</h2>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => updateState('device', {hasDownPayment: !current.device.hasDownPayment})} className={`p-4 rounded-2xl border-2 font-black text-[11px] transition ${current.device.hasDownPayment ? 'border-rose-500 bg-rose-50 text-rose-600' : 'bg-slate-50 border-transparent text-slate-400'}`}>店頭頭金 ¥11,000</button>
                                <select value={current.transfer} onChange={e => setSlots(prev => ({...prev, [activeSlot]: {...current, transfer: Number(e.target.value)}}))} className="p-4 bg-slate-50 rounded-2xl text-[11px] font-black border-none outline-none">
                                    <option value="0">データ移行なし</option>
                                    <option value="15000">データ移行(同OS) ¥15k</option>
                                    <option value="20000">データ移行(異OS) ¥20k</option>
                                </select>
                            </div>
                        </section>

                        {/* Step 6: Points */}
                        <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                            <h2 className="text-[11px] font-black text-slate-400 mb-4 flex items-center gap-2"><div className="w-1.5 h-3 bg-blue-600 rounded-full"></div>STEP 6. ノジマポイント還元</h2>
                            <div className="space-y-2">
                                {current.points.map(p => (
                                    <div key={p.id} className={`flex items-center gap-2 p-3 rounded-2xl border transition ${p.active ? 'bg-blue-50/40 border-blue-200' : 'bg-slate-50 border-transparent'}`}>
                                        <button onClick={() => setSlots(prev => ({...prev, [activeSlot]: {...current, points: current.points.map(x => x.id === p.id ? {...x, active: !x.active} : x)}}))}><Icon name={p.active ? "check-circle" : "circle"} className={`w-5 h-5 ${p.active ? 'text-blue-500' : 'text-slate-300'}`} /></button>
                                        <input type="text" value={p.name} onChange={e => setSlots(prev => ({...prev, [activeSlot]: {...current, points: current.points.map(x => x.id === p.id ? {...x, name: e.target.value} : x)}}))} className="flex-1 bg-transparent text-[11px] font-bold border-none p-0 focus:ring-0" />
                                        <div className="flex items-center gap-1">
                                            <input type="number" value={p.amount} onChange={e => setSlots(prev => ({...prev, [activeSlot]: {...current, points: current.points.map(x => x.id === p.id ? {...x, amount: e.target.value} : x)}}))} className="w-16 bg-white border rounded px-1.5 py-0.5 text-xs font-black text-right" />
                                            <span className="text-[10px] font-black text-slate-400">pt</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    </main>

                    {/* Footer Summary */}
                    <footer className="fixed bottom-0 inset-x-0 bg-white/80 backdrop-blur-xl border-t p-5 pb-8 z-50 shadow-2xl">
                        <div className="max-w-2xl mx-auto flex justify-between items-end gap-4">
                            <div className="space-y-0.5">
                                <div className="flex items-center gap-2">
                                    <span className={`px-2 py-0.5 rounded text-[9px] font-black text-white ${carrier.color}`}>{carrier.name}</span>
                                    <p className="text-[10px] font-black text-slate-400 tracking-widest">MONTHLY TOTAL</p>
                                </div>
                                <p className="text-4xl font-black tracking-tighter">¥{calc.monthlyTotal.toLocaleString()}<span className="text-[10px] font-bold ml-1 text-slate-400">/月(税込)</span></p>
                            </div>
                            <button onClick={() => setShowSummary(true)} className="bg-slate-900 text-white px-8 py-4 rounded-[2rem] font-black text-sm shadow-xl active:scale-95 transition-transform flex items-center gap-2">
                                <Icon name="file-text" className="w-4 h-4" /> 詳細
                            </button>
                        </div>
                    </footer>

                    {/* Modal */}
                    {showSummary && (
                        <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-end justify-center p-0">
                            <div className="bg-white w-full max-w-lg rounded-t-[3rem] max-h-[92vh] flex flex-col shadow-2xl overflow-hidden">
                                <div className="p-6 border-b flex justify-between items-center shrink-0">
                                    <h2 className="text-lg font-black flex items-center gap-2"><Icon name="clipboard-check" className="text-blue-600" /> お見積もり内容</h2>
                                    <button onClick={() => setShowSummary(false)} className="p-2 bg-slate-100 rounded-full"><Icon name="x" className="w-5 h-5" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-6 space-y-6 text-left">
                                    <div className="bg-slate-900 text-white rounded-[2.5rem] p-8 text-center shadow-xl space-y-2">
                                        <p className="text-[10px] font-bold opacity-50 tracking-[0.3em]">MONTHLY</p>
                                        <p className="text-6xl font-black italic">¥{calc.monthlyTotal.toLocaleString()}</p>
                                        <div className="pt-4 border-t border-white/10 flex justify-between text-[11px] font-bold opacity-80">
                                            <span>機種: {current.device.name}</span>
                                            <span>{current.device.installments}回払い</span>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-slate-50 rounded-3xl p-5 border">
                                            <p className="text-[10px] font-black text-slate-400 mb-1 flex items-center gap-1"><Icon name="wallet" className="w-3 h-3"/>本日お支払</p>
                                            <p className="text-2xl font-black">¥{calc.upfront.toLocaleString()}</p>
                                        </div>
                                        <div className="bg-blue-50 rounded-3xl p-5 border border-blue-100">
                                            <p className="text-[10px] font-black text-blue-400 mb-1 flex items-center gap-1"><Icon name="gift" className="w-3 h-3"/>ノジマpt還元</p>
                                            <p className="text-2xl font-black text-blue-600">{calc.totalPoints.toLocaleString()} <span className="text-xs">pt</span></p>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 rounded-[2.5rem] p-7 space-y-5">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest border-b pb-3 text-center italic">Important Checklist</p>
                                        <div className="space-y-4">
                                            {[
                                                { k: 'i', l: `${current.device.installments}回分割払い/月額の確認` },
                                                { k: 'r', l: `2年後返却による残価(¥${calc.residual.toLocaleString()})免除` },
                                                { k: 'f', l: `返却時の利用料22,000円の発生`, s: current.device.installments === 48 && carrier.hasFee },
                                                { k: 'c', l: `事務手数料(¥3,850)の翌月合算` },
                                                { k: 'p', l: `初期費用とポイント還元条件` }
                                            ].filter(x => x.s !== false).map(item => (
                                                <button key={item.k} onClick={() => setChecklist({...checklist, [item.k]: !checklist[item.k]})} className="flex items-start gap-3 w-full group">
                                                    <Icon name={checklist[item.k] ? "check-square" : "square"} className={`w-5 h-5 shrink-0 ${checklist[item.k] ? 'text-blue-600' : 'text-slate-300'}`} />
                                                    <span className={`text-[11px] font-bold leading-tight ${checklist[item.k] ? 'text-slate-900' : 'text-slate-500'}`}>{item.l}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <button 
                                        disabled={!isAllChecked}
                                        onClick={() => setShowSummary(false)}
                                        className={`w-full py-5 rounded-3xl font-black text-sm transition-all mb-4 ${isAllChecked ? 'bg-blue-600 text-white shadow-xl' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
                                    >
                                        {isAllChecked ? '説明を完了する' : '全ての確認が必要です'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
